CREATE OR REPLACE FUNCTION public.copy_default_decks_for_new_user()\nRETURNS TRIGGER AS $$\nDECLARE\n    default_deck record;\n    new_deck_id uuid;\n    default_card record;\nBEGIN\n    -- Iterate over all default decks\n    FOR default_deck IN SELECT * FROM public.default_decks LOOP\n        -- Insert a copy of the default deck for the new user\n        INSERT INTO public.decks (name, description, emoji, user_id, is_default, archived)\n        VALUES (\n            default_deck.name,\n            default_deck.description,\n            default_deck.emoji,\n            NEW.id, -- The ID of the newly inserted user\n            FALSE, -- This is now a user\'s copy, not the default\n            FALSE\n        )\n        RETURNING id INTO new_deck_id; -- Get the ID of the newly created user deck\n\n        -- Now, copy all flashcards from this default deck to the new user deck\n        FOR default_card IN SELECT * FROM public.default_flashcards WHERE default_deck_id = default_deck.id LOOP\n            -- Insert a copy of the default flashcard for the new user\'s deck\n            -- Note: review_stats_id should NOT be copied, a new review entry\n            -- will be created by the existing create_review_for_new_card trigger on public.cards\n            INSERT INTO public.cards (\n                deck_id,\n                english,\n                arabic,\n                transliteration,\n                image_url,\n                audio_url,\n                tags,\n                metadata,\n                type,\n                fields,\n                layout,\n                media,\n                user_id -- Assign the new user\'s ID to the card\n            )\n            VALUES (\n                new_deck_id, -- Link to the newly created user deck\\n\                default_card.english,\n                default_card.arabic,\n                default_card.transliteration,\n                default_card.image_url,\n                default_card.audio_url,\n                default_card.tags,\n                -- Optional: Adjust metadata like created_at if needed, or copy as is\n                default_card.metadata,\n                default_card.type,\n                default_card.fields,\n                default_card.layout,\n                default_card.media,\n                NEW.id -- The ID of the newly inserted user\n            );\n        END LOOP;\n    END LOOP;\n\n    RETURN NEW; -- Important for AFTER INSERT triggers\nEND;\n$$ LANGUAGE plpgsql SECURITY DEFINER; 